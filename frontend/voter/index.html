<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Voter - Vote!</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fade-in 0.4s ease-out;
        }
    </style>
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 min-h-screen">
    <div x-data="voterApp()" x-init="init()" class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-between items-center mb-4">
                <div class="flex-1"></div>
                <h1 class="text-3xl font-medium text-neutral-900 dark:text-neutral-100 flex-1">Adventure Voter</h1>
                <div class="flex-1 flex justify-end">
                    <button @click="toggleDarkMode()"
                            class="p-2 rounded-lg bg-neutral-200 dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100 hover:bg-neutral-300 dark:hover:bg-neutral-700 transition-colors">
                        <span x-show="!darkMode">üåô</span>
                        <span x-show="darkMode">‚òÄÔ∏è</span>
                    </button>
                </div>
            </div>
            <p class="text-neutral-500 dark:text-neutral-400 text-sm">Choose Your Adventure</p>
        </div>

        <!-- Connection Status -->
        <div class="mb-6 text-center">
            <div x-show="!connected" class="bg-neutral-900 dark:bg-neutral-800 text-white px-4 py-2 rounded-md text-sm">
                Connecting...
            </div>
            <div x-show="connected && !votingActive" class="bg-emerald-50 dark:bg-emerald-950 text-emerald-700 dark:text-emerald-400 px-4 py-2 rounded-md text-sm border border-emerald-200 dark:border-emerald-800">
                Connected ‚Äî Waiting for next question
            </div>
        </div>

        <!-- Voting Interface -->
        <div x-show="votingActive" class="fade-in">
            <!-- Question -->
            <div class="bg-white dark:bg-neutral-800 rounded-lg p-6 mb-6 border border-neutral-200 dark:border-neutral-700 shadow-sm">
                <h2 class="text-xl font-medium text-neutral-900 dark:text-neutral-100 mb-4 text-center" x-text="question || 'What should we do next?'">
                </h2>

                <!-- Timer -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-neutral-600 dark:text-neutral-400 mb-2">
                        <span>Time remaining</span>
                        <span x-text="timeRemaining + 's'"></span>
                    </div>
                    <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-1.5 overflow-hidden">
                        <div class="bg-blue-600 dark:bg-blue-500 h-full transition-all duration-1000"
                             :style="'width: ' + (timeRemaining / totalTime * 100) + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- Choices -->
            <div class="space-y-3">
                <template x-for="choice in choices" :key="choice.ID">
                    <button @click="vote(choice.ID)"
                            :disabled="hasVoted && selectedChoice !== choice.ID"
                            :class="{
                                'bg-blue-600 dark:bg-blue-700 text-white border-blue-600 dark:border-blue-700': selectedChoice === choice.ID,
                                'bg-white dark:bg-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-700 text-neutral-900 dark:text-neutral-100': selectedChoice !== choice.ID,
                                'opacity-40 cursor-not-allowed': hasVoted && selectedChoice !== choice.ID
                            }"
                            class="w-full rounded-lg p-4 border border-neutral-200 dark:border-neutral-700 transition-all">
                        <div class="flex items-center justify-between">
                            <div class="text-left flex-1">
                                <div class="text-lg mb-1 font-medium" x-text="choice.Label"></div>
                                <div class="text-sm opacity-70" x-text="choice.Description"></div>
                            </div>
                            <div class="ml-4">
                                <div x-show="selectedChoice === choice.ID" class="text-2xl">‚úì</div>
                            </div>
                        </div>

                        <!-- Vote Count Bar -->
                        <div x-show="showResults" class="mt-3">
                            <div class="flex justify-between text-xs mb-1 opacity-70">
                                <span x-text="results[choice.ID] || 0">0</span>
                                <span x-text="((results[choice.ID] || 0) / totalVotes * 100).toFixed(0) + '%'">0%</span>
                            </div>
                            <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-1 overflow-hidden">
                                <div class="bg-blue-500 dark:bg-blue-400 h-full transition-all duration-500"
                                     :style="'width: ' + ((results[choice.ID] || 0) / totalVotes * 100) + '%'"></div>
                            </div>
                        </div>
                    </button>
                </template>
            </div>

            <!-- Vote Confirmation -->
            <div x-show="hasVoted" class="mt-6 text-center fade-in">
                <div class="bg-emerald-600 dark:bg-emerald-700 text-white px-6 py-2 rounded-md inline-block text-sm">
                    Vote Recorded
                </div>
            </div>
        </div>

        <!-- Results View -->
        <div x-show="!votingActive && winner" class="fade-in">
            <div class="bg-white dark:bg-neutral-800 rounded-lg p-8 border border-neutral-200 dark:border-neutral-700 shadow-sm text-center">
                <h2 class="text-2xl font-medium text-neutral-900 dark:text-neutral-100 mb-6">The Team Chose</h2>
                <div class="text-xl font-medium text-blue-700 dark:text-blue-400 mb-6" x-text="getWinnerLabel()"></div>

                <!-- Results Bars -->
                <div class="space-y-3 mb-6">
                    <template x-for="choice in choices" :key="choice.ID">
                        <div class="text-left">
                            <div class="flex justify-between text-sm text-neutral-700 dark:text-neutral-300 mb-1">
                                <span x-text="choice.Label"></span>
                                <span x-text="((results[choice.ID] || 0) / totalVotes * 100).toFixed(0) + '%'">0%</span>
                            </div>
                            <div class="w-full bg-neutral-200 dark:bg-neutral-700 rounded-full h-2 overflow-hidden">
                                <div :class="choice.ID === winner ? 'bg-blue-600 dark:bg-blue-500' : 'bg-neutral-400 dark:bg-neutral-600'"
                                     class="h-full transition-all duration-1000"
                                     :style="'width: ' + ((results[choice.ID] || 0) / totalVotes * 100) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <p class="text-neutral-500 dark:text-neutral-400 text-sm">Waiting for the next chapter...</p>
            </div>
        </div>

        <!-- User ID Display -->
        <div class="mt-8 text-center text-neutral-400 dark:text-neutral-600 text-xs">
            <p>Your ID: <span class="font-mono" x-text="voterId"></span></p>
        </div>
    </div>

    <script>
        function voterApp() {
            return {
                ws: null,
                connected: false,
                voterId: '',
                votingActive: false,
                choices: [],
                selectedChoice: null,
                hasVoted: false,
                results: {},
                totalVotes: 0,
                winner: null,
                timeRemaining: 0,
                totalTime: 60,
                showResults: false,
                timerInterval: null,
                question: '',
                darkMode: false,

                init() {
                    this.voterId = this.getOrCreateVoterId();
                    this.loadDarkMode();
                    this.connectWebSocket();
                },

                loadDarkMode() {
                    this.darkMode = localStorage.getItem('darkMode') === 'true';
                    this.applyDarkMode();
                },

                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('darkMode', this.darkMode);
                    this.applyDarkMode();
                },

                applyDarkMode() {
                    if (this.darkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },

                getOrCreateVoterId() {
                    let id = localStorage.getItem('voter_id');
                    if (!id) {
                        id = 'voter_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                        localStorage.setItem('voter_id', id);
                    }
                    return id;
                },

                connectWebSocket() {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    
                    this.ws = new WebSocket(wsUrl);

                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.connected = true;
                    };

                    this.ws.onmessage = (event) => {
                        const message = JSON.parse(event.data);
                        this.handleMessage(message);
                    };

                    this.ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.connected = false;
                        // Reconnect after 3 seconds
                        setTimeout(() => this.connectWebSocket(), 3000);
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                },

                handleMessage(message) {
                    console.log('Received message:', message);

                    switch (message.type) {
                        case 'state':
                            this.updateState(message.payload);
                            break;
                        case 'voting_started':
                            this.startVoting(message.payload);
                            break;
                        case 'vote_update':
                            this.updateResults(message.payload);
                            break;
                        case 'voting_ended':
                            this.endVoting(message.payload);
                            break;
                        case 'chapter_changed':
                            this.resetForNewChapter();
                            break;
                        case 'story_restarted':
                            this.resetForNewChapter();
                            break;
                        case 'voting_reset':
                            this.resetForNewChapter();
                            break;
                    }
                },

                updateState(payload) {
                    this.votingActive = payload.voting_active || false;
                    if (payload.results) {
                        this.results = payload.results;
                        this.totalVotes = payload.total || 0;
                    }
                },

                startVoting(payload) {
                    this.votingActive = true;
                    this.choices = payload.choices || [];
                    this.question = payload.question || '';
                    this.selectedChoice = null;
                    this.hasVoted = false;
                    this.results = {};
                    this.totalVotes = 0;
                    this.winner = null;
                    this.showResults = false;
                    this.totalTime = payload.duration || 60;
                    this.timeRemaining = this.totalTime;

                    // Start timer
                    if (this.timerInterval) clearInterval(this.timerInterval);
                    this.timerInterval = setInterval(() => {
                        if (this.timeRemaining > 0) {
                            this.timeRemaining--;
                        }
                        // Show results in last 10 seconds
                        if (this.timeRemaining <= 10) {
                            this.showResults = true;
                        }
                    }, 1000);
                },

                updateResults(payload) {
                    this.results = payload.results || {};
                    this.totalVotes = payload.total || 0;
                },

                endVoting(payload) {
                    this.votingActive = false;
                    this.results = payload.results || {};
                    this.winner = payload.winner;
                    this.showResults = true;
                    
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }

                    // Calculate total votes
                    this.totalVotes = Object.values(this.results).reduce((a, b) => a + b, 0);
                },

                resetForNewChapter() {
                    this.selectedChoice = null;
                    this.hasVoted = false;
                    this.winner = null;
                    this.showResults = false;
                },

                vote(choiceId) {
                    if (this.hasVoted && this.selectedChoice === choiceId) {
                        return; // Already voted for this choice
                    }

                    this.selectedChoice = choiceId;
                    this.hasVoted = true;

                    const message = {
                        type: 'vote',
                        voter_id: this.voterId,
                        choice_id: choiceId
                    };

                    this.ws.send(JSON.stringify(message));
                },

                getWinnerLabel() {
                    if (!this.winner) return '';
                    const choice = this.choices.find(c => c.id === this.winner);
                    return choice ? choice.Label : '';
                },

                getWinnerIcon() {
                    if (!this.winner) return '';
                    const choice = this.choices.find(c => c.id === this.winner);
                    return choice ? (choice.Icon || 'üéØ') : 'üéØ';
                }
            }
        }
    </script>
</body>
</html>
